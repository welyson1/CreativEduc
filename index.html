<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de JSON Dinâmico</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>
    <link rel="stylesheet" href="./styles/index.css">
</head>

<body>    
    <div id="header">
        <img src="./images/Lg-CREATIVeduc-horizontal.png" alt="Logo CreativEduc" class="logo">
    </div>
    <div class="flex">
        <ul id="lista-processos-mobile"></ul>
        
        <div class="form">
            <!-- Novos botões -->
            <input type="file" id="jsonFileInput" style="display: none;" accept=".json">
            <button class="btn btn-info mt-3" onclick="document.getElementById('jsonFileInput').click()">Carregar Dados</button>
            <button class="btn btn-warning mt-3" onclick="downloadJSON()">Baixar Dados</button>
            <!-- Botão existente -->
            <button class="btn btn-danger mt-3" onclick="preparePrint()">Salvar Narrativa em PDF</button>
            <div id="bloco-explicacao" class="bloco-explicacao" style="display: none;"></div>
            <div id="editor"></div>
            

            <!-- visualização do objeto -->
            <!-- <pre id="output"></pre> -->

            <button class="btn btn-success mt-3" onclick="mudarEtapa(-1)">Etapa Anterior</button>
            <button class="btn btn-primary mt-3" onclick="mudarEtapa(1)">Próxima Etapa</button>
        </div>

        <div id="fluxo-processo" class="mt-3">
            <ul id="lista-processos"></ul>
        </div>

    </div>

    <script>
        let etapaAtual = 1; // Começa na primeira etapa

        const etapasConfig = {
            1: {
                campos: ["unidadeCurricular", "anoPeriodo", "conteudo", "conteudoInterdisciplinar", "habilidadesSociais", "habilidadesTecnicas", "funcoesAprendizagem"],
                textoExplicativo: null,
                processo: "Objetivos de aprendizagem",
                exibirBlocoExplicacao: false
            },
            2: {
                campos: ["tema"],
                textoExplicativo: null,
                processo: "Design Estética",
                exibirBlocoExplicacao: true
            },
            3: {
                campos: [],
                textoExplicativo: "<div class='dsc-container'> <h1 class='dsc-main-title'>Design Socialmente Consciente</h1> <div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://i.imgur.com/NUZsquE.png' alt='...'> </div> <p class='dsc-content-text'>O Design Socialmente Consciente propõe a criação de artefatos para um design mais inclusivo e sustentável, de forma colaborativa. Assim, o CreativEduc estimula a aplicação em sala de aula com a participação dos alunos na construção destes artefatos que irão ajudar na descoberta dos personagens (partes envolvidas com o tema/enredo), com o levantamento de problemas e possíveis soluções, com uma visão sistêmica do contexto, considerando elementos sociais e interativos e por fim com uma lista de requisitos sociotécnicos que comporão o jogo.</p><p class='dsc-content-text'>São quatro artefatos: diagrama das partes interessadas, quadro de avaliação, torta de valores e escada semiótica (sendo necessário o tempo aproximado de 2 a 3 aulas para os quatro artefatos). Iremos começar pela Torta de Valores.</p><p class='dsc-content-text'>Sugere-se o preenchimento da Torta de Valores junto com os alunos, utilizando o quadro branco e canetas coloridas, de forma colaborativa. Com base no tema proposto, a Torta de Valores irá subsidiar a temporalidade da história, cenário, recursos, formas de interação e socialização dos personagens etc.</p><div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://i.imgur.com/SFAuNny.png' alt='...'> <h3 class='dsc-image-caption'>Cebola Semiótica</h3> </div> <div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://i.imgur.com/ALsQBrC.png' alt='...'> </div> <div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://i.imgur.com/wpNWH85.png' alt='...'> </div> <div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://i.imgur.com/q8TDi6G.png' alt='...'> </div> <div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://i.imgur.com/dgviYhR.png' alt='...'> </div> <div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://i.imgur.com/NEbg5MR.png' alt='...'> </div> <div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://i.imgur.com/lpZZ2TJ.png' alt='...'> </div> ",
                processo: "DSC - Torta de Valores",
                exibirBlocoExplicacao: false
            },
            4: {
                campos: ["ambientacaoAtmosfera", "ambientacaoCenario", "ambientacaoEspaco"],
                textoExplicativo: null,
                processo: "Design Estética",
                exibirBlocoExplicacao: false
            },            
            5: {
                campos: [],
                textoExplicativo: "<div class='dsc-container'> <h1 class='dsc-main-title'>Diagrama das Partes Interessadas</h1> <p class='dsc-content-text'>O Diagrama das Partes Interessadas é utilizado pelo DSC para identificar os principais envolvidos e outras pessoas interessadas no contexto da solução. O DPI possui cinco camadas, sendo o núcleo, camada de operação (utilizado para o nome da aplicação, neste caso o nome do jogo), em seguida a camada de contribuição, fonte, mercado e comunidade. Quanto mais próximo do núcleo, maior é o envolvimento da pessoa. No RPG, as partes interessadas identificadas podem ser transformadas em personagens: protagonistas (os mais próximos ao núcleo), antagonistas e coadjuvantes.</p><p>Sugere-se o preenchimento do DPI junto com os alunos, utilizando o quadro branco e canetas coloridas, de forma colaborativa.</p> <div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://i.imgur.com/FLDbdN6.png' alt='...'> </div> <div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://i.imgur.com/smU46nV.png' alt='...'> </div></div>",
                processo: "DSC - Diagrama das Partes Interessadas",
                exibirBlocoExplicacao: false
            },
            6: {
                campos: ["personagens"],
                textoExplicativo: null,
                processo: "Design Dinâmica/Mecânica",
                exibirBlocoExplicacao: false
            },            
            7: {
                campos: [],
                textoExplicativo: "<div class='dsc-container'> <h1 class='dsc-main-title'>Quadro de Avaliação</h1> <p class='dsc-content-text'> <p>O Quadro de Avaliação é utilizado pelo DSC para identificar problemas e/ou levantar questões de acordo com a visão das partes interessadas descobertas no DPI, bem como propor ideias e/ou soluções para os problemas levantados. O resultado do quadro de avaliação poderá ser utilizado para a composição do enredo. Sugere-se o preenchimento do Quadro de Avaliação junto com os alunos, logo após o preenchimento do DPI, utilizando o quadro branco e canetas coloridas, de forma colaborativa.</p> </p> <div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://i.imgur.com/MCQjCxA.png' alt='...'> </div></div>",
                processo: "DSC - Quadro de Avaliação",
                exibirBlocoExplicacao: false
            },
            8: {
                campos: ["enredo"],
                textoExplicativo: null,
                processo: "Design Estética",
                exibirBlocoExplicacao: false
            },
            9: {
                campos: ["sessoes"],
                textoExplicativo: null,
                processo: "Design Dinamica",
                exibirBlocoExplicacao: false
            },
            10: {
                campos: ["regrasAleatoriedade", "regrasRecompensas", "regrasFeedback"],
                textoExplicativo: null,
                processo: "Design Mecânica",
                exibirBlocoExplicacao: false
            },
            11: {
                campos: ["materiais"],
                textoExplicativo: null,
                processo: "Materiais",
                exibirBlocoExplicacao: false
            },           
            12: {
                campos: [],
                textoExplicativo: "<div class='dsc-container'> <h1 class='dsc-main-title'>Escada semiótica</h1> <div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://imgur.com/jAqts72' alt='...'> </div> <div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://i.imgur.com/00BsA8k.png' alt='...'> </div> <div class='dsc-image-wrapper'> <img class='dsc-content-image' src='https://i.imgur.com/FpTZ2ky.png' alt='...'> </div></div>",
                processo: "DSC - Escada Semiotica",
                exibirBlocoExplicacao: false
            },           
            13: {
                campos: [],
                textoExplicativo: "<div class='dsc-container'>    <h1 class='dsc-main-title'>Criação da narrativa</h1><div class='callout-note'><strong>Nota:</strong> Se estiver satisfeito com o resultado, copie este texto e cole na página seguinte <strong>'Narrativa'</strong> para gerar o PDF. Se quiser ajuda da IA, acesse <a href='https://chatgpt.com/' target='_blank'>https://chatgpt.com/</a> e cole este prompt! Você ainda pode editar este texto antes de gerar a narrativa final.</div>    <p class='dsc-content-text'>        Crie um RPG educacional em que o aluno possa <strong>[funcoesAprendizagem.Criar]</strong>, para aprender mais sobre         <strong>[conteudo]</strong> e <strong>[conteudoInterdisciplinar]</strong>. O jogo deve estimular o exercício das habilidades sociais e interpessoais:         <strong>[habilidadesSociais]</strong> e <strong>[habilidadesTecnicas]</strong>. O RPG deve utilizar o tema <strong>[tema]</strong> e apresentar um ambiente         <strong>[ambientacaoAtmosfera]</strong>. O cenário principal é <strong>[ambientacaoCenario]</strong>, com espaços jogáveis em         <strong>[ambientacaoEspaco]</strong>. Os personagens devem possuir a seguinte descrição: <strong>[personagens.descricao]</strong> da categoria         <strong>[personagens.categoria]</strong>, para resolver o problema <strong>[enredo.problema.descricao]</strong>, superando o desafio         <strong>[enredo.problema.desafio]</strong> e explorando possíveis soluções <strong>[enredo.problema.solucao]</strong>.         Cada protagonista terá habilidades técnicas <strong>[habilidadesTecnicas]</strong> e habilidades sociais <strong>[habilidadesSociais]</strong> específicas.         Além disso, defina parâmetros de caracterização dos personagens e estabeleça regras de aleatoriedade para eventos e desafios do jogo.         O jogo deve conter sessões <strong>[sessoes.nome]</strong> com cenas descritas como <strong>[sessoes.cenas.descricao]</strong> para resolver o desafio         <strong>[enredo.problema.desafio]</strong>. A aleatoriedade pode utilizar <strong>[regrasAleatoriedade]</strong>, prever         <strong>[regrasRecompensas]</strong> e fornecer <strong>[regrasFeedback]</strong>. Utilize os materiais: <strong>[materiais.descricao]</strong>.</div>",
                processo: "Instrução para IA",
                exibirBlocoExplicacao: false
            },
            14: {
                campos: ["narrativa"],
                textoExplicativo: "Texto normal sem ser prompt.",
                processo: "Narrativa",
                exibirBlocoExplicacao: true
            }
        };

        // Objeto inicial
        let database = {
            "unidadeCurricular": "",
            "anoPeriodo": "",
            "conteudo": "",
            "conteudoInterdisciplinar": "",
            "habilidadesSociais": [],
            "habilidadesTecnicas": [],
            "funcoesAprendizagem": {
                "Criar": "",
                "Aplicar": "",
                "Sintetizar": "",
                "Entender": "",
                "Analisar": "",
                "Lembrar": ""
            },
            "ambientacaoAtmosfera": "",
            "ambientacaoCenario": "",
            "ambientacaoEspaco": [],
            "enredo": {
                "problema": []
            },
            "tema": "",
            "sessoes": [],
            "regrasAleatoriedade": "",
            "regrasRecompensas": "",
            "regrasFeedback": "",
            "personagens": [],
            "materiais": [],
            "narrativa": ""
        };

        // Carregar dados do localStorage
        const savedData = localStorage.getItem("database");
        if (savedData) {
            database = JSON.parse(savedData);
        }

        // Configuração do JSON Editor
        const editor = new JSONEditor(document.getElementById("editor"), {
            schema: {
                "type": "object",
                "title": "Formulário",
                "properties": {
                    "unidadeCurricular": {
                        "type": "string",
                        "title": "Unidade Curricular",
                        "description": "Nome da unidade curricular"
                    },
                    "anoPeriodo": {
                        "type": "string",
                        "title": "Ano/Período",
                        "description": "Ano e período letivo"
                    },
                    "conteudo": {
                        "type": "string",
                        "title": "Conteúdo",
                        "description": "Incluir um ou mais conteúdos da unidade curricular que deseja trabalhar no jogo."
                    },
                    "conteudoInterdisciplinar": {
                        "type": "string",
                        "title": "Conteúdo Interdisciplinar",
                        "description": "Incluir um ou mais conteúdos da unidade curricular que deseja trabalhar no jogo."
                    },
                    "habilidadesSociais": {
                        "type": "array",
                        "title": "Habilidades sociais e interpessoais",
                        "description": "Selecione pelo menos duas habilidades, sendo que duas deve ser o mínimo que você deseja que o aluno desenvolva/exercite.",
                        "items": {
                            "type": "string",
                            "title": "Habilidade Social",
                            "enum": ["Capacidade de entender e solucionar problemas", "Ética e Responsabilidade", "Questões sociais e culturais por meio de análise de contexto de forma não técnica", "Análise do impacto nas mudanças sociais ocasionadas pela tecnologia", "Resolução de conflitos", "Visão sistêmica", "Consciência crítica e aguçada"],
                            "ui": {
                                "widget": "select"
                            }
                        }
                    },
                    "habilidadesTecnicas": {
                        "type": "array",
                        "title": "Habilidades Técnicas",
                        "items": {
                            "type": "string",
                            "title": "Habilidade Técnicas",
                            "description": "Habilidades Técnicas a serem desenvolvidas",
                            "ui": {
                                "widget": "select"
                            }
                        }
                    },
                    "funcoesAprendizagem": {
                        "type": "object",
                        "title": "Funções de Aprendizagem",
                        "properties": {
                            "Criar": {
                                "type": "string",
                                "title": "Criar",
                                "description": "Funções cognitivas relacionadas à criação",
                                "enum": ["", "Planejar", "Combinar", "Compor", "Efetivar"],
                                "ui": { "widget": "select" }
                            },
                            "Aplicar": {
                                "type": "string",
                                "title": "Aplicar",
                                "description": "Funções cognitivas relacionadas à aplicação",
                                "enum": ["", "Classificar", "Experimentar", "Calcular", "Construir"],
                                "ui": { "widget": "select" }
                            },
                            "Sintetizar": {
                                "type": "string",
                                "title": "Sintetizar",
                                "description": "Funções cognitivas relacionadas à síntese",
                                "enum": ["", "Raquear", "Avaliar", "Concluir", "Agir"],
                                "ui": { "widget": "select" }
                            },
                            "Entender": {
                                "type": "string",
                                "title": "Entender",
                                "description": "Funções cognitivas relacionadas ao entendimento",
                                "enum": ["", "Resumir", "Interpretar", "Prever", "Executar"],
                                "ui": { "widget": "select" }
                            },
                            "Analisar": {
                                "type": "string",
                                "title": "Analisar",
                                "description": "Funções cognitivas relacionadas à análise",
                                "enum": ["", "Ordenar", "Explicar", "Diferenciar", "Alcançar"],
                                "ui": { "widget": "select" }
                            },
                            "Lembrar": {
                                "type": "string",
                                "title": "Lembrar",
                                "description": "Funções cognitivas relacionadas à memória",
                                "enum": ["", "Listar", "Descrever", "Tabular", "Uso apropriado"],
                                "ui": { "widget": "select" }
                            }
                        }
                    },
                    "ambientacaoAtmosfera": {
                        "type": "string",
                        "title": "Ambientação/Atmosfera",
                        "description": "A atmosfera representa o clima em que a ação se desenvolve. É um momento feliz, triste? Relaxado, ou tenso? O que estava acontecendo naquele ambiente ou com aqueles personagens antes da cena começar (cada cenário e espaço poderão ser enriquecidos de detalhes, mas vinculado à atmosfera). Uma boa atmosfera prende a atenção do leitor, apelando para suas emoções e fazendo com que ele crie uma conexão emocional não só com os personagens, mas com todo o universo ficcional. Utilize o resultado da Torta de Valores para compor a atmosfera da narrativa. Pode ainda, neste campo, colocar palavras-chave caso queira usar a IA no final do preenchimento dos demais campos."
                    },
                    "ambientacaoCenario": {
                        "type": "string",
                        "title": "Ambientação Cenario",
                        "description": "O cenário é um guia que orienta quanto à localização espacial (em uma casa, em um escritório, em uma cidade), localização temporal (século, passado, presente, futuro) e ainda contribui com peças-chave sobre o personagem apresentando sua condição financeira (classe e poder aquisitivo) e ainda pode refletir aspectos psicológicos ou detalhes sobre a personalidade. Utilize o resultado da Torta de Valores para compor o cenário da narrativa. Pode ainda, neste campo, colocar palavras-chave caso queira usar a IA no final do preenchimento dos demais campos."
                    },
                    "ambientacaoEspaco": {
                        "type": "array",
                        "title": "Ambientação Espaço",
                        "description": "O espaço é a extensão do cenário, em que é possível descrever detalhes do ambiente físico, ambiente psicológico ou ambiente social em que as cenas ocorrem. O cenário pode ser decomposto em vários espaços. Por exemplo: se o cenário representa uma cidade, a narrativa pode conter cenas em bar (o bar é um espaço da cidade) que será descrito para uma determinada cena. Ainda aqui a Torta de Valores pode ser utilizada bem como palavras-chave para o prompt da IA.",
                        "items": {
                            "type": "string",
                            "title": "Ambientação Espaço"
                        }
                    },
                    "enredo": {
                        "type": "object",
                        "title": "Enredo",
                        "description": "O enredo é o encadeamento de eventos que compõem a sua narrativa.",
                        "properties": {
                            "problema": {
                                "type": "array",
                                "title": "Problemas",
                                "items": {
                                    "type": "object",
                                    "title": "Problema",
                                    "properties": {
                                        "descricao": {
                                            "type": "string",
                                            "title": "Descrição do Problema"
                                        },
                                        "desafio": {
                                            "type": "string",
                                            "title": "Desafio"
                                        },
                                        "solucao": {
                                            "type": "string",
                                            "title": "Solução Proposta"
                                        }
                                    },
                                    "required": ["descricao", "desafio", "solucao"]
                                }
                            }
                        },
                        "required": ["problema"]
                    },
                    "tema": {
                        "type": "string",
                        "title": "Tema",
                        "description": "Definir um tema. O tema é a ideia central da narrativa, a mensagem de impacto que o escritor quer transmitir para o leitor. É a ideia sob a qual o texto será fundamentado. Ex. Viagem à Lua; Caça ao tesouro; Mundo virtual; Viagem no tempo; Seca no Nordeste; Em busca da felicidade etc."
                    },
                    "sessoes": {
                        "type": "array",
                        "title": "Sessões",
                        "description": "As sessões determinam quantas aulas serão utilizadas para o jogo, cada sessão equivale a 2 aulas. Cada sessão deve prever as cenas (desafios a serem realizados pelos jogadores) e possibilitar que todos participem, ou seja, que todos joguem pelo menos uma vez (isto é chamado de turno). A quantidade mínima de turnos deve ser a quantidade de jogadores por grupo. Pode acontecer de o jogo não prever turnos, apenas passar o desafio e o grupo resolve de acordo com as diretrizes do jogo.",
                        "items": {
                            "type": "object",
                            "title": "Sessão",
                            "properties": {
                                "nome": {
                                    "type": "string",
                                    "title": "Nome",
                                },
                                "cenas": {
                                    "type": "array",
                                    "title": "Cenas",
                                    "items": {
                                        "type": "object",
                                        "title": "Cena",
                                        "properties": {
                                            "descricao": {
                                                "type": "string",
                                                "title": "Descrição",
                                            },
                                            "turnos": {
                                                "type": "integer",
                                                "title": "Turnos",
                                            }
                                        },
                                        "required": ["descricao", "turnos"]
                                    }
                                }
                            },
                            "required": ["nome", "cenas"]
                        }
                    },
                    "regrasAleatoriedade": {
                        "type": "string",
                        "title": "Aleatoriedade",
                        "description": "Regras de aleatoriedade"
                    },
                    "regrasRecompensas": {
                        "type": "string",
                        "title": "Recompensas",
                        "description": "Regras de recompensas"
                    },
                    "regrasFeedback": {
                        "type": "string",
                        "title": "Feedback",
                        "description": "Regras de feedback"
                    },
                    "personagens": {
                        "type": "array",
                        "title": "Personagens",
                        "items": {
                            "type": "object",
                            "title": "Personagem",
                            "properties": {
                                "descricao": {
                                    "type": "string",
                                    "title": "Descrição",
                                    "description": "Descrição do personagem"
                                },
                                "funcoes": {
                                    "type": "array",
                                    "title": "Função",
                                    "items": {
                                        "title": "Função",
                                        "type": "string",
                                        "description": "Funções a serem desempenhadas"
                                    }
                                },
                                "categoria": {
                                    "type": "string",
                                    "title": "Categoria",
                                    "description": "Categoria do personagem",
                                    "enum": ["Protagonistas", "Antagonistas", "Coadjuvantes", "Narrador"],
                                    "ui": {
                                        "widget": "select"
                                    }
                                },
                                "habilidadesTecnicas": {
                                    "type": "array",
                                    "title": "Habilidades Tecnicas",
                                    "items": {
                                        "type": "object",
                                        "title": "Habilidade Tecnica",
                                        "properties": {
                                            "descricao": {
                                                "type": "string",
                                                "title": "Descrição",
                                                "description": "Descrição da habilidade técnica"
                                            },
                                            "parametros": {
                                                "type": "string",
                                                "title": "Parâmetros",
                                                "description": "Parâmetros da habilidade técnica"
                                            }
                                        }
                                    }
                                },
                                "habilidadesSociais": {
                                    "type": "array",
                                    "title": "Habilidades Sociais",
                                    "items": {
                                        "type": "object",
                                        "title": "Habilidade Social",
                                        "properties": {
                                            "descricao": {
                                                "type": "string",
                                                "description": "Descrição da habilidade social"
                                            },
                                            "parametros": {
                                                "type": "string",
                                                "title": "Parametros",
                                                "description": "Parâmetros da habilidade social"
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    },
                    "materiais": {
                        "type": "array",
                        "title": "Materiais",
                        "items": {
                            "type": "object",
                            "title": "Material",
                            "properties": {
                                "descricao": {
                                    "type": "string",
                                    "title": "Descrição",
                                    "description": "Descrição do material"
                                },
                                "quantidade": {
                                    "type": "integer",
                                    "title": "Quantidade",
                                    "description": "Quantidade do material"
                                }
                            },
                            "required": ["descricao", "quantidade"]
                        }
                    },
                    "narrativa": {
                        "type": "string",
                        "title": "Narrativa",
                        "description": "Narrativa principal",
                        "format": "textarea",
                        "options": {
                            "input_height": "300px"
                        }
                    }
                }
            },
            startval: database,
            theme: "bootstrap4",
            iconlib: "bootstrap4",
            disable_collapse: true,
            disable_edit_json: true,
            disable_properties: false,
            no_additional_properties: true,
            prompt_before_delete: false,
            array_controls_top: false
        });

        function saveData() {
            const updatedData = editor.getValue();
            database = updatedData; // Atualiza o objeto database com os novos valores
            localStorage.setItem("database", JSON.stringify(updatedData, null, 4));
            // document.getElementById("output").textContent = JSON.stringify(updatedData, null, 4);

            // Atualiza o bloco de explicação com os novos valores
            exibirBlocoExplicacao();
        }

        function atualizarCampos() {
            const propriedades = editor.root.getChildEditors();
            const camposEtapa = etapasConfig[etapaAtual].campos || [];

            Object.keys(propriedades).forEach((campo) => {
                if (camposEtapa.includes(campo)) {
                    propriedades[campo].container.style.display = "block"; // Exibe o campo
                } else {
                    propriedades[campo].container.style.display = "none"; // Oculta o campo
                }
            });
        }

        function atualizarFluxo() {
            const listaProcessos = document.getElementById("lista-processos");
            listaProcessos.innerHTML = "";

            Object.entries(etapasConfig).forEach(([etapa, config]) => {
                let item = document.createElement("li");

                item.innerHTML =
                    `<span style="background-color: ${parseInt(etapa) <= etapaAtual ? 'rgb(15, 173, 86)' : 'transparent'}; color: ${parseInt(etapa) <= etapaAtual ? 'white' : 'black'}">${etapa}</span> <button class="menu-button" style="color: ${parseInt(etapa) === etapaAtual ? 'rgb(15, 173, 86)' : ''};" onclick="etapaAtual = ${etapa}; atualizarFluxo(); atualizarCampos(); exibirBlocoExplicacao(); saveData();">${config.processo}</button>`;

                // Destaca a etapa atual
                if (parseInt(etapa) === etapaAtual) {
                    item.classList.add("destacado");
                }

                listaProcessos.appendChild(item);
            });

            const listaProcessosMobile = document.getElementById("lista-processos-mobile");
            listaProcessosMobile.innerHTML = "";

            Object.entries(etapasConfig).forEach(([etapa, config]) => {
                let item = document.createElement("li");

                listaProcessosMobile.appendChild(item);
                if (parseInt(etapa) === etapaAtual) {
                    item.innerHTML =
                        `<span>${etapa}</span> ${config.processo}`;
                }
            });
        }

        function exibirBlocoExplicacao() {
            const blocoExplicacao = document.getElementById("bloco-explicacao");
            const editorDiv = document.getElementById("editor");

            const configEtapa = etapasConfig[etapaAtual];

            // Exibe ou oculta o bloco de explicação
            if (configEtapa.textoExplicativo) {
                const textoExplicativo = substituirPlaceholders(configEtapa.textoExplicativo, database);

                // Verifica se o texto contém placeholders (campos dinâmicos)
                const contemCampos = /\[(.*?)\]/.test(configEtapa.textoExplicativo);

                // Exibe o botão de copiar apenas se o texto contiver campos dinâmicos
                const botaoCopiar = contemCampos
                    ? `<button class="btn btn-secondary mt-3" onclick="copiarTextoExplicativo()">Copiar Texto</button>`
                    : "";

                // Exibe a caixa de explicação
                blocoExplicacao.innerHTML = `
                    <div>${textoExplicativo}</div>
                    ${botaoCopiar}
                `;
                blocoExplicacao.style.display = "block";
            } else {
                blocoExplicacao.style.display = "none";
            }

            // Exibe ou oculta o formulário
            if (configEtapa.exibirBlocoExplicacao || !configEtapa.textoExplicativo) {
                editorDiv.style.display = "block"; // Exibe o formulário
            } else {
                editorDiv.style.display = "none"; // Oculta o formulário
            }
        } 

        /**
         * Substitui os placeholders no template pelos valores correspondentes no objeto data.
         * Se o campo for um array, a função mapeia cada elemento automaticamente sem precisar de índice.
         * Não há nenhuma formatação ou tags HTML na saída.
         *
         * @param {string} texto - O template contendo os placeholders.
         * @param {object} data - Objeto com os dados (JSON) a serem utilizados.
         * @returns {string} - Texto com os placeholders substituídos por texto puro.
         */
        function substituirPlaceholders(texto, data) {
        // Função auxiliar para formatar valores (arrays, objetos ou primitivos) em texto puro
        function formatValue(value) {
            if (Array.isArray(value)) {
            if (value.length === 0) return "[não preenchido]";
            return value.map(item => formatValue(item)).join(", ");
            }
            if (typeof value === "object" && value !== null) {
            return Object.entries(value)
                .map(([key, val]) => key + ": " + formatValue(val))
                .join(", ");
            }
            return value === "" ? "" : value;
        }

        // Função auxiliar que percorre o objeto ou array de forma recursiva, sem precisar de índice para arrays.
        function getNestedValue(dado, parts) {
            if (parts.length === 0) return dado;
            const primeiro = parts[0];
            const resto = parts.slice(1);
            
            if (Array.isArray(dado)) {
            // Aplica o mesmo caminho para cada item do array
            return dado.map(item => getNestedValue(item, parts));
            } else if (dado && typeof dado === "object") {
            if (Object.prototype.hasOwnProperty.call(dado, primeiro)) {
                return getNestedValue(dado[primeiro], resto);
            }
            return undefined;
            }
            return undefined;
        }

        // Realiza a substituição dos placeholders
        return texto.replace(/\[(.*?)\]/g, (match, campo) => {
            const parts = campo.split(".").filter(p => p.trim() !== "");
            const valor = getNestedValue(data, parts);
            return (valor !== undefined && valor !== null)
            ? formatValue(valor)
            : `[${campo} não preenchido]`;
        });
        }

        function copiarTextoExplicativo() {
            const blocoExplicacao = document.getElementById("bloco-explicacao");
            const paragrafo = blocoExplicacao.querySelector("p.dsc-content-text"); // Seleciona apenas o <p class="dsc-content-text">

            if (paragrafo) {
                const textoParaCopiar = paragrafo.innerText; // Obtém o texto do <p>

                // Usa a API de Clipboard para copiar o texto
                navigator.clipboard.writeText(textoParaCopiar)
                    .then(() => alert("Texto copiado com sucesso!"))
                    .catch(() => alert("Erro ao copiar o texto."));
            } else {
                alert("Nenhum texto encontrado para copiar.");
            }
        }

        // Atualiza ao mudar de etapa
        function mudarEtapa(direcao) {
            etapaAtual = Math.max(1, Math.min(14, etapaAtual + direcao));
            atualizarFluxo();
            atualizarCampos();
            exibirBlocoExplicacao(); // Atualiza o bloco de explicação
            saveData(); // Salva os dados e atualiza o bloco de explicação
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        setTimeout(() => {
            atualizarFluxo();
            atualizarCampos();
            exibirBlocoExplicacao();
        }, 100);

        // Função para baixar o JSON
        function downloadJSON() {
            const dataStr = JSON.stringify(database, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `rpg-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Função para carregar JSON
        document.getElementById('jsonFileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    database = loadedData;
                    editor.setValue(loadedData);
                    localStorage.setItem("database", JSON.stringify(loadedData));
                    atualizarFluxo();
                    exibirBlocoExplicacao();
                    alert("Dados carregados com sucesso!");
                } catch (error) {
                    alert("Erro ao carregar arquivo. Verifique o formato.");
                }
            };
            reader.readAsText(file);
        });

        function preparePrint() {
            saveData();
            // Salva no localStorage e abre nova página
            localStorage.setItem('printNarrative', database.narrativa);
            window.open('print.html', '_blank');          
        }

    </script>
</body>
</html>